{# templates/commercial/dashboard.html.twig #}
{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content %}
  <style>
    /* Forcer le contenu en pleine largeur et masquer l’aside EasyAdmin */
    .ea-content, .ea-content .content, .ea-content .content-panel { width: 100% !important; display:block !important; }
    .content-sidebar, .ea-aside, .aside { display:none !important; }

    .content-wrapper {
      display: block;
    }

    .resizer-handler {
        display: none; 
    }

    .section-card .card-header{
      display:flex; align-items:center; justify-content:flex-start;
    }
    .section-card .card-header h3{ margin:0; font-weight:600; }
    .chart-container{ height:380px; }

    .kpi-card .label { font-size:.9rem; color:#6c757d; margin-bottom:.35rem; }
    .kpi-card .value { font-size:1.8rem; font-weight:700; }
  </style>

  <h1 class="mb-4">Tableau de bord Commercial</h1>

  {# ====== FILTRE MOIS ====== #}
  <form method="get" action="{{ path('commercial_dashboard') }}" class="row g-3 align-items-end mb-4">
    <div class="col-auto">
      <label class="form-label">Mois</label>
      <input type="month" name="month" class="form-control" value="{{ selectedMonth }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" type="submit">Appliquer</button>
    </div>
  </form>

  {# ====== KPI PAR STATUT ====== #}
  <div class="row">
    {% for statut, total in devisCounts %}
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow mb-3 kpi-card">
          <div class="card-body">
            <div class="label">{{ statut }}</div>
            <div class="value">{{ total }}</div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="col-12">
        <div class="alert alert-info">Aucun devis pour la période sélectionnée.</div>
      </div>
    {% endfor %}
  </div>

  {# ====== GRAPHE JOURNALIER PAR STATUT ====== #}
  <div class="section-card card shadow mb-4">
    <div class="card-header">
      <h3>Devis par jour ({{ selectedMonth }})</h3>
    </div>
    <div class="card-body">
      <div class="chart-container">
        <canvas id="devisChart"></canvas>
      </div>
    </div>
  </div>

  {# Optionnel : répartition (camembert) sur le mois #}
  <div class="section-card card shadow mb-4">
    <div class="card-header">
      <h3>Répartition des statuts ({{ selectedMonth }})</h3>
    </div>
    <div class="card-body">
      <div class="chart-container">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function () {
      const labels = {{ chartLabels|json_encode|raw }}; // ['01','02',...]
      const byStatus = {{ chartDataByStatus|json_encode|raw }}; // { "Envoyé":[..], "BAT/Production":[..], ... }

      // Construire un dataset par statut
      const lineDatasets = Object.entries(byStatus).map(([label, data]) => ({
        label,
        data,
        type: 'line',
        fill: false,
        tension: 0.25
      }));

      new Chart(document.getElementById('devisChart'), {
        data: { labels, datasets: lineDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} devis`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });

      // Camembert des totaux par statut
      const counts = {{ devisCounts|json_encode|raw }}; // { "Envoyé":12, ... }
      const pieLabels = Object.keys(counts);
      const pieValues = Object.values(counts);

      new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: {
          labels: pieLabels,
          datasets: [{
            label: 'Totaux',
            data: pieValues
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed} devis` }
            }
          },
          cutout: '55%'
        }
      });
    })();
  </script>
{% endblock %}
